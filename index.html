<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Family To-Do List</title>
    <style>
      :root {
        --bg: #0b1220;
        --card: #121a2b;
        --muted: #7f8ca3;
        --text: #e9eef7;
        --accent: #4f8cff;
        --accent-2: #22c55e;
        --danger: #ef4444;
        --border: #1e2a44;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 800px at 20% -10%, #1b2a48 0%, #0b1220 50%, #0b1220 100%);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .app {
        width: 100%;
        max-width: 760px;
        background: rgba(18,26,43,0.8);
        backdrop-filter: blur(8px);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        overflow: hidden;
      }
      header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      .badge { font-weight: 600; color: var(--muted); font-size: 13px; }
      .tabs {
        display: flex;
        gap: 8px;
        background: #0f1626;
        padding: 6px;
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      .tab {
        padding: 8px 12px;
        border-radius: 8px;
        color: var(--muted);
        cursor: pointer;
        user-select: none;
        border: 1px solid transparent;
      }
      .tab.active {
        background: var(--card);
        border-color: var(--border);
        color: var(--text);
      }
      main { padding: 16px; }
      .add-row { display: flex; gap: 10px; margin-bottom: 16px; }
      .category-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; }
      label { color: var(--muted); font-size: 14px; }
      select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1626;
        color: var(--text);
        outline: none;
      }
      input[type="text"] {
        flex: 1;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1626;
        color: var(--text);
        outline: none;
      }
      button {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1626;
        color: var(--text);
        cursor: pointer;
      }
      button.primary { background: linear-gradient(180deg, #5b96ff, #4f8cff); border-color: #416ed6; }
      button.success { background: linear-gradient(180deg, #35d16f, #22c55e); border-color: #1da34f; }
      button.ghost { background: #0f1626; }
      button.danger { background: linear-gradient(180deg, #f66060, #ef4444); border-color: #d13f3f; }
      .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
      .list { display: grid; gap: 10px; }
      .item {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
        padding: 12px;
        background: #0f1626;
        border: 1px solid var(--border);
        border-radius: 12px;
      }
      .item .meta { color: var(--muted); font-size: 12px; }
      .badge-cat {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 999px;
        background: rgba(79,140,255,0.12);
        color: #a9c5ff;
        border: 1px solid rgba(79,140,255,0.35);
      }
      .badge-cat svg { opacity: 0.9; }
      .actions { display: flex; gap: 8px; }
      .empty { color: var(--muted); text-align: center; padding: 24px; border: 1px dashed var(--border); border-radius: 12px; background: rgba(15,22,38,0.6);}      
      footer { padding: 14px 16px; border-top: 1px solid var(--border); color: var(--muted); font-size: 13px; display: flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
      a { color: var(--accent); text-decoration: none; }
      
      /* Login page styles */
      .login-page {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .login-card {
        width: 100%;
        max-width: 400px;
        background: rgba(18,26,43,0.9);
        backdrop-filter: blur(8px);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      }
      .login-header {
        text-align: center;
        margin-bottom: 32px;
      }
      .login-header h1 {
        margin: 16px 0 8px 0;
        font-size: 24px;
        font-weight: 700;
      }
      .login-header p {
        color: var(--muted);
        margin: 0;
      }
      .login-form {
        margin-bottom: 24px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        color: var(--text);
        font-weight: 500;
      }
      .form-group input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1626;
        color: var(--text);
        outline: none;
        font-size: 16px;
      }
      .form-group input:focus {
        border-color: var(--accent);
      }
      .login-btn {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 16px;
      }
      .divider {
        text-align: center;
        margin: 24px 0;
        position: relative;
      }
      .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--border);
      }
      .divider span {
        background: rgba(18,26,43,0.9);
        padding: 0 16px;
        color: var(--muted);
        font-size: 14px;
      }
      .google-btn {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1626;
        color: var(--text);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s;
      }
      .google-btn:hover {
        background: #1a2332;
        border-color: var(--accent);
      }
      .login-footer {
        text-align: center;
        margin-top: 24px;
      }
      .login-footer p {
        color: var(--muted);
        font-size: 14px;
        margin: 0;
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        font-size: 14px;
      }
      .user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
      }
      
      /* Share Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .modal-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }
      .close-btn {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-body {
        margin-bottom: 16px;
      }
      .modal-footer {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .modal input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1626;
        color: var(--text);
        outline: none;
        font-size: 16px;
        margin-bottom: 12px;
      }
      .modal input:focus {
        border-color: var(--accent);
      }
      .modal label {
        display: block;
        margin-bottom: 6px;
        color: var(--text);
        font-weight: 500;
      }
      .shared-users {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }
      .shared-user {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
      .shared-user:last-child {
        border-bottom: none;
      }
      .remove-user {
        background: var(--danger);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="login-page" class="login-page">
      <div class="login-card">
        <div class="login-header">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 11L12 14L22 4" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V5A2 2 0 0 1 5 3H16" stroke="#7f8ca3" stroke-width="2" stroke-linecap="round"/></svg>
          <h1>Family To-Do List</h1>
          <p>Sign in to access your shared list</p>
        </div>
        
        <form class="login-form" id="login-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Enter your email" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password" required />
          </div>
          <button type="submit" class="login-btn primary">Sign In</button>
        </form>
        
        <div class="divider">
          <span>or</span>
        </div>
        
        <button id="google-signin" class="google-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Sign in with Google
        </button>
        
        <div class="login-footer">
          <p>No account? Gmail sign-in will create one automatically</p>
        </div>
      </div>
    </div>

    <div id="app" class="app" role="application" style="display: none;">
      <header>
        <div class="title">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M9 11L12 14L22 4" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V5A2 2 0 0 1 5 3H16" stroke="#7f8ca3" stroke-width="2" stroke-linecap="round"/></svg>
          Family To‑Do
          <span class="badge">Simple shared list</span>
          <div class="user-info" id="user-info" style="display: none;">
            <div class="user-avatar" id="user-avatar"></div>
            <span id="user-name"></span>
            <button id="logout-btn" class="ghost" style="margin-left: 8px; padding: 4px 8px; font-size: 12px;">Logout</button>
          </div>
        </div>
        <div class="tabs" role="tablist" aria-label="Sections">
          <div class="tab active" role="tab" aria-selected="true" data-tab="add">Add Items</div>
          <div class="tab" role="tab" aria-selected="false" data-tab="pending">Pending Items</div>
          <div class="tab" role="tab" aria-selected="false" data-tab="completed">Completed Items</div>
        </div>
      </header>

      <main>
        <!-- Add Items -->
        <section id="view-add" class="view">
          <div class="category-row">
            <label for="category-select">Category</label>
            <select id="category-select" aria-label="Category"></select>
            <button id="add-cat-btn" class="ghost" aria-label="Add category">+ Add Category</button>
          </div>
          <div class="add-row">
            <input id="item-input" type="text" placeholder="Add a new item… (e.g., Buy milk)" aria-label="Item text" />
            <button id="add-btn" class="primary" aria-label="Add item">Add</button>
          </div>
          <div class="toolbar">
            <button id="share-btn" class="ghost" title="Share list with others">Share List</button>
            <button id="import-btn" class="ghost" title="Import shared list">Import</button>
            <button id="clear-btn" class="danger" title="Clear everything">Clear All</button>
          </div>
        </section>

        <!-- Pending Items -->
        <section id="view-pending" class="view" hidden>
          <div id="pending-list" class="list" role="list"></div>
          <div id="pending-empty" class="empty" hidden>No pending items. Add something in the Add tab.</div>
        </section>

        <!-- Completed Items -->
        <section id="view-completed" class="view" hidden>
          <div id="completed-list" class="list" role="list"></div>
          <div id="completed-empty" class="empty" hidden>No completed items yet.</div>
        </section>
      </main>

      <footer>
        <div>Realtime sync enabled. List code: <strong id="list-code">…</strong></div>
        <div>Open this same URL on your partner's device to stay in sync.</div>
      </footer>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Share List</h3>
          <button class="close-btn" id="close-share-modal">&times;</button>
        </div>
        <div class="modal-body">
          <label for="share-email">Add user by email:</label>
          <input type="email" id="share-email" placeholder="Enter email address" />
          <button id="add-user-btn" class="primary">Add User</button>
          
          <div class="shared-users" id="shared-users">
            <h4>Shared with:</h4>
            <div id="shared-users-list"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="close-modal-btn" class="ghost">Close</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
      import { getDatabase, ref, onValue, set, update, get, child } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
      import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

      // Simple shared list with localStorage persistence and manual share/import
      // Data model: { id, text, status: 'pending'|'completed', createdAt }
      const STORAGE_KEY = 'family-shared-list:v2';
      const CATEGORY_KEY = 'family-shared-list:categories';
      const LIST_ID_KEY = 'family-shared-list:list-id';

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyD09h6PUFBIWpdHWA_EG-XWu5FpwJYW5TI",
        authDomain: "fir-task-planner.firebaseapp.com",
        databaseURL: "https://fir-task-planner-default-rtdb.firebaseio.com",
        projectId: "fir-task-planner",
        storageBucket: "fir-task-planner.appspot.com",
        messagingSenderId: "989187282939",
        appId: "1:989187282939:web:xxxxxxxxxx"
      };

      const hasFirebaseConfig = Object.values(firebaseConfig).some(v => (v || '').trim() !== "");
      let app, db;
      let auth, provider;
      if (hasFirebaseConfig) {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
        provider = new GoogleAuthProvider();
      }

      // Auth state management
      let currentUser = null;
      function showLoginPage() {
        document.getElementById('login-page').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
      }
      function showApp() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app').style.display = 'block';
      }
      function updateUserInfo(user) {
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        if (user) {
          userInfo.style.display = 'flex';
          userAvatar.textContent = user.email.charAt(0).toUpperCase();
          userName.textContent = user.email;
        } else {
          userInfo.style.display = 'none';
        }
      }

      // Auth event listeners
      if (hasFirebaseConfig) {
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          if (user) {
            showApp();
            updateUserInfo(user);
            // Populate category dropdown immediately when user logs in
            populateCategorySelect();
          } else {
            showLoginPage();
            updateUserInfo(null);
          }
        });
      } else {
        // No auth in local mode
        showApp();
        populateCategorySelect();
      }

      // Login form handler
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!hasFirebaseConfig) {
          alert('Firebase not configured. Please use Google sign-in or configure Firebase.');
          return;
        }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
          alert('Login failed: ' + error.message);
        }
      });

      // Google sign-in handler
      document.getElementById('google-signin').addEventListener('click', async () => {
        if (!hasFirebaseConfig) {
          alert('Firebase not configured. Please configure Firebase to use Google sign-in.');
          return;
        }
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          alert('Google sign-in failed: ' + error.message);
        }
      });

      // Logout handler
      document.getElementById('logout-btn').addEventListener('click', async () => {
        if (hasFirebaseConfig && auth) {
          await signOut(auth);
        }
      });

      function currentListId() {
        const hash = location.hash.startsWith('#') ? location.hash.slice(1) : '';
        const params = new URLSearchParams(hash);
        let id = params.get('list') || localStorage.getItem(LIST_ID_KEY);
        if (!id) {
          id = Math.random().toString(36).slice(2, 8);
          localStorage.setItem(LIST_ID_KEY, id);
          const np = new URLSearchParams(params);
          np.set('list', id);
          history.replaceState({}, document.title, `${location.pathname}${location.search}#${np.toString()}`);
        }
        const codeEl = document.getElementById('list-code');
        if (codeEl) codeEl.textContent = id;
        return id;
      }
      const LIST_ID = currentListId();

      /**
       * Utilities
       */
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const now = () => new Date().toISOString();
      const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

      let memoryItems = [];
      let memoryCats = [];

      function loadState() {
        try {
          const raw = localStorage.getItem(`${STORAGE_KEY}:${LIST_ID}`);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch { return []; }
      }
      function saveState(items) {
        localStorage.setItem(`${STORAGE_KEY}:${LIST_ID}`, JSON.stringify(items));
      }
      function getItems() { return hasFirebaseConfig ? memoryItems : loadState(); }
      function setItems(items) {
        memoryItems = items;
        saveState(items);
        render();
      }

      // Categories persistence
      function loadCategories() {
        try {
          const raw = localStorage.getItem(`${CATEGORY_KEY}:${LIST_ID}`);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return null;
          return parsed;
        } catch { return null; }
      }
      function saveCategories(cats) {
        localStorage.setItem(`${CATEGORY_KEY}:${LIST_ID}`, JSON.stringify(cats));
      }
      function ensureDefaultCategories() {
        const existing = loadCategories();
        if (existing && existing.length) return existing;
        const defaults = ['Visa', 'Car', 'New House Work'];
        saveCategories(defaults);
        return defaults;
      }
      function populateCategorySelect() {
        const select = $('#category-select');
        if (!select) {
          return;
        }
        const cats = ensureDefaultCategories();
        select.innerHTML = '';
        for (const c of cats) {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        }
        memoryCats = cats;
      }

      function addItem(text) {
        const trimmed = (text || '').trim();
        if (!trimmed) return;
        const category = ($('#category-select')?.value || '').trim();
        const catVal = category || 'Uncategorized';
        const items = getItems();
        const next = [{ id: uid(), text: trimmed, status: 'pending', createdAt: now(), category: catVal }, ...items];
        if (hasFirebaseConfig) {
          set(ref(db, `lists/${LIST_ID}/items`), next).then(() => {
            setItems(next);
          });
        } else {
          setItems(next);
        }
        $('#item-input').value = '';
        switchTab('pending');
      }
      function markComplete(id) {
        const items = getItems().map(it => it.id === id ? { ...it, status: 'completed' } : it);
        if (hasFirebaseConfig) {
          set(ref(db, `lists/${LIST_ID}/items`), items).then(() => setItems(items));
        } else {
          setItems(items);
        }
      }
      function markPending(id) {
        const items = getItems().map(it => it.id === id ? { ...it, status: 'pending' } : it);
        if (hasFirebaseConfig) {
          set(ref(db, `lists/${LIST_ID}/items`), items).then(() => setItems(items));
        } else {
          setItems(items);
        }
      }
      function removeItem(id) {
        const items = getItems().filter(it => it.id !== id);
        if (hasFirebaseConfig) {
          set(ref(db, `lists/${LIST_ID}/items`), items).then(() => setItems(items));
        } else {
          setItems(items);
        }
      }

      // Rendering
      function render() {
        const items = getItems();
        const pending = items.filter(i => i.status === 'pending');
        const completed = items.filter(i => i.status === 'completed');

        const pendingList = $('#pending-list');
        const pendingEmpty = $('#pending-empty');
        pendingList.innerHTML = '';
        if (pending.length === 0) {
          pendingEmpty.hidden = false;
        } else {
          pendingEmpty.hidden = true;
          pending.forEach(item => pendingList.appendChild(renderItem(item, 'pending')));
        }

        const completedList = $('#completed-list');
        const completedEmpty = $('#completed-empty');
        completedList.innerHTML = '';
        if (completed.length === 0) {
          completedEmpty.hidden = false;
        } else {
          completedEmpty.hidden = true;
          completed.forEach(item => completedList.appendChild(renderItem(item, 'completed')));
        }
      }

      function renderItem(item, listType) {
        const el = document.createElement('div');
        el.className = 'item';
        el.setAttribute('role', 'listitem');
        const created = new Date(item.createdAt).toLocaleString();
        const catBadge = (item.category) ? `
            <div class="badge-cat" title="${escapeHtml(item.category)}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7H20" stroke="#a9c5ff" stroke-width="1.6" stroke-linecap="round"/><path d="M6 12H18" stroke="#a9c5ff" stroke-width="1.6" stroke-linecap="round"/><path d="M9 17H15" stroke="#a9c5ff" stroke-width="1.6" stroke-linecap="round"/></svg>
              <span>${escapeHtml(item.category)}</span>
            </div>` : '';
        el.innerHTML = `
          <div>
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <span>${escapeHtml(item.text)}</span>
              ${catBadge}
            </div>
            <div class="meta">Added ${created}</div>
          </div>
          <div class="actions">
            ${listType === 'pending' ? '<button class="success" data-action="complete">Mark Complete</button>' : '<button class="ghost" data-action="uncomplete">Move to Pending</button>'}
            <button class="ghost" data-action="edit">Edit</button>
            <button class="danger" data-action="delete">Delete</button>
          </div>
        `;
        el.querySelector('[data-action="complete"]')?.addEventListener('click', () => markComplete(item.id));
        el.querySelector('[data-action="uncomplete"]')?.addEventListener('click', () => markPending(item.id));
        el.querySelector('[data-action="delete"]')?.addEventListener('click', () => removeItem(item.id));
        el.querySelector('[data-action="edit"]')?.addEventListener('click', () => editItem(item.id));
        return el;
      }

      function editItem(id) {
        const items = getItems();
        const idx = items.findIndex(i => i.id === id);
        if (idx === -1) return;
        const current = items[idx];
        const nextText = prompt('Edit item text:', current.text);
        if (nextText == null) return;
        const trimmed = nextText.trim();
        if (!trimmed) return;
        items[idx] = { ...current, text: trimmed };
        if (hasFirebaseConfig) {
          set(ref(db, `lists/${LIST_ID}/items`), items).then(() => setItems(items));
        } else {
          setItems(items);
        }
      }

      function escapeHtml(str) {
        return str
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      // Tabs
      function switchTab(tab) {
        $$('.tab').forEach(t => {
          const active = t.dataset.tab === tab;
          t.classList.toggle('active', active);
          t.setAttribute('aria-selected', String(active));
        });
        $$('#view-add, #view-pending, #view-completed').forEach(v => v.hidden = true);
        if (tab === 'add') $('#view-add').hidden = false;
        if (tab === 'pending') $('#view-pending').hidden = false;
        if (tab === 'completed') $('#view-completed').hidden = false;
        render();
      }

      $$('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
      $('#add-btn').addEventListener('click', () => addItem($('#item-input').value));
      $('#item-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') addItem($('#item-input').value); });

      // Category add button
      $('#add-cat-btn').addEventListener('click', () => {
        const name = prompt('New category name:');
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        const cats = ensureDefaultCategories();
        if (!cats.includes(trimmed)) {
          cats.push(trimmed);
          if (hasFirebaseConfig) {
            set(ref(db, `lists/${LIST_ID}/categories`), cats).then(() => {
              saveCategories(cats);
              populateCategorySelect();
              $('#category-select').value = trimmed;
            });
            return;
          }
          saveCategories(cats);
          populateCategorySelect();
          $('#category-select').value = trimmed;
        } else {
          $('#category-select').value = trimmed;
        }
      });

      // Share / Import / Clear
      $('#share-btn').addEventListener('click', () => {
        if (!hasFirebaseConfig || !currentUser) {
          alert('Please sign in to share lists.');
          return;
        }
        document.getElementById('share-modal').style.display = 'flex';
        loadSharedUsers();
      });

      // Modal handlers
      document.getElementById('close-share-modal').addEventListener('click', () => {
        document.getElementById('share-modal').style.display = 'none';
      });
      document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('share-modal').style.display = 'none';
      });
      document.getElementById('add-user-btn').addEventListener('click', addSharedUser);

      // Share functionality
      function addSharedUser() {
        const email = document.getElementById('share-email').value.trim();
        if (!email) return;
        
        if (!hasFirebaseConfig) {
          alert('Firebase not configured for sharing.');
          return;
        }

        // Add user to shared list
        const sharedUsersRef = ref(db, `lists/${LIST_ID}/sharedUsers`);
        get(sharedUsersRef).then((snapshot) => {
          const sharedUsers = snapshot.val() || {};
          sharedUsers[email] = {
            email: email,
            addedBy: currentUser.email,
            addedAt: now()
          };
          set(sharedUsersRef, sharedUsers).then(() => {
            document.getElementById('share-email').value = '';
            loadSharedUsers();
            alert(`Invitation sent to ${email}`);
          });
        });
      }

      function loadSharedUsers() {
        if (!hasFirebaseConfig) return;
        
        const sharedUsersRef = ref(db, `lists/${LIST_ID}/sharedUsers`);
        onValue(sharedUsersRef, (snapshot) => {
          const sharedUsers = snapshot.val() || {};
          const container = document.getElementById('shared-users-list');
          container.innerHTML = '';
          
          Object.values(sharedUsers).forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'shared-user';
            userDiv.innerHTML = `
              <span>${escapeHtml(user.email)}</span>
              <button class="remove-user" onclick="removeSharedUser('${user.email}')">Remove</button>
            `;
            container.appendChild(userDiv);
          });
        });
      }

      function removeSharedUser(email) {
        if (!hasFirebaseConfig) return;
        
        const sharedUsersRef = ref(db, `lists/${LIST_ID}/sharedUsers`);
        get(sharedUsersRef).then((snapshot) => {
          const sharedUsers = snapshot.val() || {};
          delete sharedUsers[email];
          set(sharedUsersRef, sharedUsers);
        });
      }

      // Make removeSharedUser globally available
      window.removeSharedUser = removeSharedUser;

      $('#import-btn').addEventListener('click', () => {
        const input = prompt('Paste a share link or exported JSON:');
        if (!input) return;
        try {
          let json;
          if (input.includes('#data=')) {
            const encoded = input.split('#data=')[1];
            json = decodeURIComponent(escape(atob(encoded)));
          } else {
            json = input;
          }
          const arr = JSON.parse(json);
          if (!Array.isArray(arr)) throw new Error('Invalid data');
          // Merge by id, newest wins
          const current = getItems();
          const byId = new Map(current.map(i => [i.id, i]));
          for (const it of arr) byId.set(it.id, it);
          setItems(Array.from(byId.values()).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
          alert('Imported successfully!');
        } catch (e) {
          alert('Import failed. Make sure you pasted a valid link or JSON.');
        }
      });

      $('#clear-btn').addEventListener('click', () => {
        if (confirm('Clear all items?')) { setItems([]); }
      });

      // Auto-import if URL has data
      (function autoImportFromHash() {
        const hash = location.hash;
        if (!hash.startsWith('#data=')) return render();
        try {
          const encoded = hash.slice('#data='.length + 1 - 1); // keep exact behavior
          const json = decodeURIComponent(escape(atob(encoded)));
          const arr = JSON.parse(json);
          if (Array.isArray(arr)) {
            // Merge instead of replace
            const current = getItems();
            const byId = new Map(current.map(i => [i.id, i]));
            for (const it of arr) byId.set(it.id, it);
            const merged = Array.from(byId.values()).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (hasFirebaseConfig) {
              set(ref(db, `lists/${LIST_ID}/items`), merged).then(() => setItems(merged));
            } else {
              setItems(merged);
            }
            // Clean the hash
            history.replaceState({}, document.title, location.pathname + location.search);
          }
        } catch {
          // ignore
          render();
        }
      })();

      // Access control
      function checkUserAccess() {
        if (!hasFirebaseConfig || !currentUser) return false;
        
        const sharedUsersRef = ref(db, `lists/${LIST_ID}/sharedUsers`);
        return get(sharedUsersRef).then((snapshot) => {
          const sharedUsers = snapshot.val() || {};
          const userEmail = currentUser.email;
          
          // Check if user is the list owner or in shared users
          return sharedUsers[userEmail] || Object.keys(sharedUsers).length === 0; // Allow if no users added yet (list owner)
        });
      }

      // Realtime listeners with access control
      if (hasFirebaseConfig) {
        checkUserAccess().then((hasAccess) => {
          if (!hasAccess) {
            alert('You do not have access to this list. Please ask the owner to share it with you.');
            signOut(auth);
            return;
          }
          
          // User has access, load the data
          // First, populate with defaults immediately
          populateCategorySelect();
          
          onValue(ref(db, `lists/${LIST_ID}/categories`), (snap) => {
            const cats = snap.val();
            if (Array.isArray(cats)) {
              saveCategories(cats);
              populateCategorySelect();
            } else {
              // seed defaults
              const seeded = ensureDefaultCategories();
              set(ref(db, `lists/${LIST_ID}/categories`), seeded);
              saveCategories(seeded);
              populateCategorySelect();
            }
          });
          onValue(ref(db, `lists/${LIST_ID}/items`), (snap) => {
            const arr = snap.val();
            if (Array.isArray(arr)) {
              setItems(arr);
            } else {
              // seed empty
              set(ref(db, `lists/${LIST_ID}/items`), []);
              setItems([]);
            }
          });
        });
      } else {
        // Local mode
        populateCategorySelect();
        render();
      }
      
      // Always populate category dropdown regardless of Firebase state
      populateCategorySelect();
      
      // Also populate when DOM is fully loaded
      document.addEventListener('DOMContentLoaded', function() {
        populateCategorySelect();
      });
    </script>
  </body>
  </html>


